---
outline: [2, 3]
tags: AWS
publishDate: 2022/03/03
---

# RDS

> Relational Database Service 关系型数据库服务

## 定义

允许从 AWS 云上管理创建数据库：

- Postgres
- MySQL
- Oracle
- MAriaDB
- Microsoft SQL Server
- Aurora(AWS 专有数据库)
- RDS 可以：
  - 完全自动化，操作系统补丁
  - 持续备份，恢复到指定的时间戳(时间点还原)
  - 监控仪表盘
  - 使用只读副本来提高读性能
  - 多 AZ 用于容灾
  - 升级的维护窗口
  - 扩展功能(垂直和水平)
  - 使用 EBS 存储(gp2 或者 io1)
- 但是不能使用 SSH 链接到 RDS 实例

## 存储自动缩放

> Storage Auto Scaling

- 动态为 RDS 数据库提高存储
- 当 RDS 预测到可用空间，会自动缩放
- 避免手动缩放数据库的存储
- 需要设置一个存储最大阈值
- 当...自动修改存储：
  - 免费存储空间少于已分配空间的 10%
  - 低存储一直持续 5 分钟以上
  - 距离上次修改过去了 6 个小时
- 对于工作量不可预测的应用很有效
- 支持所有 RDS 数据库引擎

## 只读副本

可以扩展阅读量

### 定义

- 至多可以创建五个只读副本
- 它们可以在 AZ 内，跨 AZ 或者跨 Region
- 在主 RDS 数据库实例和副本之间是异步复制
- 副本可以晋升到自己的数据库中，就脱离了复制机制
- **要想使用只读副本，应用程序必须更新连接字符串到只读副本列表**
- 用例：一些报告类的应用可以从只读副本读取数据并分析，而不影响实际 RDS 实例的性能和负载，只适用于`Select`类型的语句

### 网络成本

- 通常的，当数据从一个 AZ 转到另一个 AZ 时是有网络代价的
- 但是有些例外，就是托管服务，而只读副本就是一个托管服务，它们会在同一个 Region，不需要额外支付

## 容灾(多 AZ)

- 同步复制
- 一个 DNS 名 - 自动应用程序故障切换到备用
- 提高了可用性
- 在失去 AZ，失去网络、实例或存储故障的情况下进行故障转移
- 在应用程序中没有人工干预
- 不用于缩放
- 可以将只读副本设置为多个分区

![容灾](/src/assets/aws-rds-recovery.png)

### 从单 AZ 到多 AZ

- 无需停机
- 只需点击修改 - 启用多可用区
- 将发生：
  - RDS 会自动生成快照
  - 快照被恢复到一个新的备用数据库
  - 一旦恢复将与原数据库建立同步

## 自定义

我们在 RDS 无法访问任何底层操作系统，但是可以使用 RDS Custom 来实现：

- 适用于 Oracle 和 Microsoft SQL Server
- 对于 RDS 是全自动化的设置，操作和缩放
- 但是对于 Custom：可以访问底层操作系统：
  - 配置内部设置
  - 安装补丁
  - 启用本机功能
  - 使用 SSH 或 SSM 访问底层 EC2 实例
- 要执行定制，建议停用自动化模式，这样 RDS 就不会执行任何自动化操作，而且应该制作快照以用于恢复

## Aurora

### 定义

- 是 AWS 专有的，不是开源的
- 支持 Postgres 和 MySQL
- 得益于对它的大量优化，性能很好，比如：3 倍于 RDS Postgres，5 倍于 RDS MySQL
- 自动增长容量从 10GB - 128TB
- 最多可以有 15 个只读副本，而 MySQL 只有 5 个，并且速度更快
- 瞬间的故障转移
- 大约比 RDS 多 20%成本，但是更加高效

### 高可用性和副本

- 数据会跨 3 个 AZ 有 6 个副本
  - 其中 4 个用于写
  - 其中 3 个用于读
  - 点对点自我修复
  - 依赖数百个卷
- 写入到一个实例上(master)
- 30s 内故障转移
- master 上 15 个只读副本，所有副本都是服务读取
- 默认只有一个 master
- 支持跨区域复制

### AuroraDB 集群

Aurora 提供一个写入端点(Writer Endpoint)指向 master，也就是一个 DNS 名称，即使 master 故障转移，也会仍然与客户端连接。
同时提供一个读取端点(Reader Endpoint)，有助于连接负载平衡，会自动连接到所有只读副本。所以只要客户端连接到读取端点，就能连接到其中一个只读副本，并且以这种方式实现负载均衡（这里的负载均衡指的是连接级别，而不是语句级别）。

### 高级功能

- 只读副本自动缩放
- 自定义端点
- serverless
- 多 Master
- 全球化：
  - 跨区域只读副本
    - 用于容灾
    - 安装简单
  - 全球数据库
    - 推荐
    - 一个主要区域(读/写)
    - 至多 5 个次级只读区域
    - 至多 16 个只读副本每个次级区域
    - 也可用于容灾
    - 减少延迟
    - 平均跨区域复制不会超过 1 秒
- 机器学习：
  - 优化应用，预测
  - 支持 SageMaker(使用任意的机器学习模型) Comprehend(用于情绪分析)
  - 无需任何机器学习知识
  - 用例：欺诈检测，情绪分析，广告定位，产品推荐

## 备份

- 自动备份
  - 每日完整备份
  - 每 5 分钟备份事务日志
  - 恢复到任何时间点
  - 1 - 35 天保留，RDS 可以禁用掉，Aurora 不可以禁用
- 手动数据库快照
  - 用户手动触发
  - 保留任意长时间
- 技巧：什么时候使用备份？
  - 如果想节省成本，同时你知道每个月只有 2 小时使用数据库，就可以在使用两小时之后进行快照，然后删除原始数据库，当准备再次使用时，使用快照并恢复它。

### 恢复选项

- 恢复一个 RDS/Aurora 备份或者使用快照创建一个新的数据库
- 从 S3 恢复 MySQL 数据库
  - 创建备份
  - 保存 S3
  - 恢复到一个新的运行 MySQL 的 RDS 实例上
- 从 S3 恢复 MySQL Aurora 集群
  - 创建备份(用到软件 Percona XtraBackup)
  - 将备份存储到 S3
  - 恢复到一个新的运行 MySQL 的 Aurora 集群上

### AuroraDB 克隆

- 从现有 AuroraDB 集群创建一个新的
- 要快于快照和恢复
- 新的集群使用的是同样的卷，而且当被更新时它会随时间更新
- 从生产数据库创建一个 Staging 数据库而不影响生产

## 安全

- 静态加密：这意味着数据在卷上被加密
  - 必须在启动的时候使用 AWS KMS 定义 db master 和 加密副本
  - 如果 master 未加密，那么副本也不能被加密
  - 要加密一个未加密的 db，使用快照，恢复数据库并加密
- 飞行中加密：于客户端与数据库之间加密，客户端必须使用 TLS 证书
- 权限认证：
  - username/pw
  - IAM 角色
- 安全组：可以允许或阻止特定端口
- 无 SSH：除非使用自定义服务 RDS Custom
- 审计日志：可以在很长时间段内保留，可以将他们发送到专门的服务中，比如 CloudWatch Logs

## 代理

- 提高数据库效率：减少了数据库资源(CPU,RAM)的压力，并最小化打开连接
- serverless，自动缩放，高可用性(多 AZ)
- 故障转移时间减少多达 66%：不是让所有应用程序都直接连接到 RDS 实例，它们只会链接到代理，代理将自行处理故障转移。
- 支持 RDS 和 Aurora
- 对于大多数应用无需修改代码
- 强制要求 IAM 认证，然后安全存储这些平局到另一个 AWS 密钥管理器(Secrets Manager)的服务中
- RDS 代理永远无法公开访问
- 对于 Lambd 函数，它们可能有很多，很快出现又很快消失，如果直接连接到 RDS 实例，将是一个大问题，因为它们会留下开放的连接和超时

## 缓存(ElastiCache)

### 定义

- 与 RDS 相同的管理方式
- 托管 Redis 或 Memcached
- 高性能，低延迟
- 可以减少数据库的负载：常见的查询将被缓存，因此不会每次都查询数据库，而是使用缓存来检索查询结果
- 可以使应用程序无状态
- AWS 负责了 OS 维护/补丁，优化设置，配置监控，故障转移，备份
- 需要做很多应用程序的代码修改

### 缓存工作原理

> 下图展示的知识懒加载方式的原理：
> ![缓存工作原理](/src/assets/aws-rds-cache.png)

### 无状态原理

![无状态原理](/src/assets/aws-rds-stateless.png)

### Redis vs Memcached

| Redis                        | Memcached            |
| ---------------------------- | -------------------- |
| 多 AZ 自动故障转移           | 用于数据分区的多节点 |
| 只读副本，高可用性           | 没有高可用性和副本   |
| AOF 数据持久化               | 无持久缓存           |
| 备份和恢复                   | 无备份和恢复         |
| 支持 Sets 集合排序 Sets 集合 | 多线程架构           |

### 缓存安全

- **支持 IAM 身份验证**
- **ElastiCache 上的 IAM 策略仅仅用于 AWS API 级别的安全性**
- **Reaids AUTH**
  - 可以在创建 Redis 集群的时候设置密码或者 token
  - 者提供了额外的安全级别，用于安全组之上的缓存
  - 支持 SSL 动态加密
- Memcached
  - 支持基于 SASL 的认证

### 加载缓存的方式

> There are only two hard things in Computer Science: cache invalidation and naming things

- 懒加载：所有读取的数据都被缓存，缓存中的数据可能会过时
- Write Through：每当写入 DB 的时候，添加或更新数据到缓存中
- Session Store：将临时会话数据存入缓存

### 用例

- 实时游戏排行榜
- Redis Sorted sets：保证了唯一性和元素排序
- 每次添加一个元素时，就会被排名，被添加到正确的顺序

## 端口

**Important ports:**

- FTP: 21
- SSH: 22
- SFTP: 22 (same as SSH)
- HTTP: 80
- HTTPS: 443

**vs RDS Databases ports:**

- PostgreSQL: 5432
- MySQL: 3306
- Oracle RDS: 1521
- MSSQL Server: 1433
- MariaDB: 3306 (same as MySQL)
- Aurora: 5432 (if PostgreSQL compatible) or 3306 (if MySQL compatible)
